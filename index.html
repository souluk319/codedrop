<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeDrop: Neon Cyberpunk</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Orbitron:wght@400;700;900&display=swap');

        :root {
            --bg-color: #050505;
            --glass-bg: rgba(10, 10, 12, 0.65);
            --glass-border: rgba(0, 243, 255, 0.2);
            --primary-neon: #00f3ff;
            --secondary-neon: #bc13fe;
            --text-color: #e0e6ed;
            --danger-color: #ff2a6d;
            --success-color: #05ffa1;
            --font-code: 'JetBrains Mono', monospace;
            --font-display: 'Orbitron', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-code);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- Background Effects --- */
        .bg-grid {
            position: absolute;
            top: 0;
            left: 0;
            width: 200%;
            height: 200%;
            background-image:
                linear-gradient(var(--glass-border) 1px, transparent 1px),
                linear-gradient(90deg, var(--glass-border) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg) translateY(-100px) translateZ(-200px);
            animation: gridMove 20s linear infinite;
            opacity: 0.3;
            z-index: -2;
            pointer-events: none;
        }

        @keyframes gridMove {
            0% {
                transform: perspective(500px) rotateX(60deg) translateY(0) translateZ(-200px);
            }

            100% {
                transform: perspective(500px) rotateX(60deg) translateY(60px) translateZ(-200px);
            }
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.3) 50%, rgba(0, 0, 0, 0.3));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 999;
            opacity: 0.4;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 50%, #000 150%);
            pointer-events: none;
            z-index: 998;
        }

        /* --- HUD --- */
        #hud {
            height: 80px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            background: rgba(5, 5, 10, 0.8);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.1);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .hud-group {
            display: flex;
            gap: 40px;
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hud-label {
            font-family: var(--font-display);
            font-size: 0.7rem;
            color: var(--primary-neon);
            letter-spacing: 2px;
            text-shadow: 0 0 5px var(--primary-neon);
            margin-bottom: 5px;
        }

        .hud-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        #lives-display {
            color: var(--danger-color);
            text-shadow: 0 0 10px var(--danger-color);
            font-size: 1.8rem;
            letter-spacing: 5px;
        }

        /* --- Game Area --- */
        #game-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .word-item {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--primary-neon);
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid var(--primary-neon);
            box-shadow: 0 0 10px var(--primary-neon), inset 0 0 10px rgba(0, 243, 255, 0.2);
            text-shadow: 0 0 5px var(--primary-neon);
            white-space: nowrap;
            transition: all 0.1s;
        }

        .word-item.target {
            border-color: var(--success-color);
            color: var(--success-color);
            box-shadow: 0 0 20px var(--success-color), inset 0 0 10px rgba(5, 255, 161, 0.3);
            text-shadow: 0 0 10px var(--success-color);
            z-index: 10;
            transform: translateX(-50%) scale(1.1);
        }

        .word-item.event {
            border-color: var(--secondary-neon);
            color: var(--secondary-neon);
            box-shadow: 0 0 15px var(--secondary-neon);
            text-shadow: 0 0 8px var(--secondary-neon);
        }

        .word-item.matched {
            transform: translateX(-50%) scale(1.5);
            opacity: 0;
            filter: blur(10px);
            transition: all 0.3s ease-out;
        }

        /* --- Input Area --- */
        #input-area {
            height: 120px;
            background: rgba(5, 5, 10, 0.9);
            border-top: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 20;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.8);
        }

        #target-display {
            height: 24px;
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        #target-display span.match {
            color: var(--success-color);
            text-shadow: 0 0 10px var(--success-color);
        }

        #target-display span.rest {
            color: #888;
        }

        #input-field {
            width: 700px;
            max-width: 90%;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            color: #fff;
            font-family: var(--font-code);
            font-size: 2rem;
            text-align: center;
            outline: none;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.8);
            transition: all 0.2s;
        }

        #input-field:focus {
            border-color: var(--primary-neon);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3), inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        #input-field.error {
            border-color: var(--danger-color);
            box-shadow: 0 0 20px var(--danger-color);
            animation: shake 0.3s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-2px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(4px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-6px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(6px, 0, 0);
            }
        }

        /* --- Overlays & Cards --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            overflow-y: auto;
            scrollbar-gutter: stable;
            /* Force scrollbar to prevent layout shift */
            padding: 40px 0;
        }

        /* Electric Background Effect */
        .overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                linear-gradient(transparent 95%, var(--primary-neon) 96%, transparent 97%),
                linear-gradient(90deg, transparent 95%, var(--primary-neon) 96%, transparent 97%);
            background-size: 100px 100px;
            opacity: 0.1;
            animation: electric-grid 2s linear infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes electric-grid {
            0% {
                background-position: 0 0;
                opacity: 0.1;
            }

            50% {
                opacity: 0.2;
            }

            100% {
                background-position: 50px 50px;
                opacity: 0.1;
            }
        }

        .hidden {
            display: none !important;
        }

        .card {
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid var(--glass-border);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            width: 400px;
            height: 550px;
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1), inset 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Decorative corner accents for card */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, transparent, var(--primary-neon), transparent);
        }

        h1 {
            font-family: var(--font-display);
            font-size: 4rem;
            margin-bottom: 30px;
            color: #fff;
            text-transform: uppercase;
            position: relative;
            text-shadow: 2px 2px var(--danger-color), -2px -2px var(--primary-neon);
            animation: glitch 3s infinite;
        }

        @keyframes glitch {
            0% {
                text-shadow: 2px 2px var(--danger-color), -2px -2px var(--primary-neon);
            }

            2% {
                text-shadow: -2px 2px var(--danger-color), 2px -2px var(--primary-neon);
                transform: translate(2px, -2px);
            }

            4% {
                text-shadow: 2px -2px var(--danger-color), -2px 2px var(--primary-neon);
                transform: translate(-2px, 2px);
            }

            6% {
                text-shadow: 2px 2px var(--danger-color), -2px -2px var(--primary-neon);
                transform: translate(0, 0);
            }

            100% {
                text-shadow: 2px 2px var(--danger-color), -2px -2px var(--primary-neon);
            }
        }

        /* --- Controls --- */
        .select-group {
            margin: 15px 0;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--primary-neon);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--glass-border);
            color: #fff;
            border-radius: 4px;
            font-family: var(--font-code);
            font-size: 1rem;
            outline: none;
            transition: 0.3s;
        }

        input[type="text"]:focus,
        select:focus {
            border-color: var(--primary-neon);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }

        .btn {
            background: transparent;
            color: var(--primary-neon);
            border: 2px solid var(--primary-neon);
            padding: 15px 40px;
            font-size: 1.2rem;
            font-family: var(--font-display);
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
            transition: 0.3s;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        .btn:hover {
            background: var(--primary-neon);
            color: #000;
            box-shadow: 0 0 30px var(--primary-neon);
        }

        .btn-small {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--primary-neon);
            color: var(--primary-neon);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 0.8rem;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-small:hover {
            background: var(--primary-neon);
            color: #000;
            box-shadow: 0 0 15px var(--primary-neon);
        }

        /* --- Leaderboard --- */
        #leaderboard-preview {
            margin-top: 20px;
            background: rgba(10, 10, 15, 0.8);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            width: 400px;
            max-width: 90%;
            height: 550px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            margin: 0;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            color: #666;
            font-size: 0.8rem;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        td {
            padding: 8px 0;
            color: #ccc;
            font-size: 0.9rem;
            border-bottom: 1px solid #222;
        }

        .rank-1 {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .rank-2 {
            color: #c0c0c0;
        }

        .rank-3 {
            color: #cd7f32;
        }

        /* --- Pause Screen --- */
        #pause-screen {
            background: rgba(0, 0, 0, 0.9);
            cursor: pointer;
        }

        #pause-screen h1 {
            font-size: 6rem;
            margin: 0;
            animation: pulse 2s infinite;
        }

        #pause-screen p {
            font-family: var(--font-display);
            color: var(--primary-neon);
            letter-spacing: 3px;
            margin-top: 20px;
            animation: blink 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                text-shadow: 0 0 20px var(--primary-neon);
                transform: scale(1);
            }

            50% {
                text-shadow: 0 0 40px var(--primary-neon);
                transform: scale(1.05);
            }
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* --- Result Screen --- */
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #fff;
            margin-top: 5px;
        }

        /* --- Music Widget (Bottom Right) --- */
        #music-widget {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* State: Closed (Button) */
        #music-widget.closed {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(5, 5, 10, 0.9);
            border: 2px solid var(--primary-neon);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #music-widget.closed:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--primary-neon);
        }

        #music-widget.closed .widget-content {
            display: none;
        }

        #music-widget.closed .widget-icon {
            display: flex;
        }

        /* State: Open (Player) */
        #music-widget.open {
            width: 350px;
            height: 350px;
            border-radius: 12px;
            background: rgba(5, 5, 10, 0.95);
            border: 1px solid var(--primary-neon);
            box-shadow: 0 0 40px rgba(0, 243, 255, 0.2);
            display: flex;
            flex-direction: column;
            opacity: 0.3;
            /* Semi-transparent when playing */
            transition: opacity 0.3s ease;
        }

        #music-widget.open:hover {
            opacity: 1;
            /* Fully visible on hover */
            box-shadow: 0 0 60px rgba(0, 243, 255, 0.4);
            z-index: 10000;
            /* Ensure it's on top when interacting */
        }

        #music-widget.open .widget-icon {
            display: none;
        }

        #music-widget.open .widget-content {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
        }

        /* Icon Styling */
        .widget-icon {
            flex-direction: column;
            align-items: center;
            color: var(--primary-neon);
        }

        .boombox-svg {
            width: 32px;
            height: 32px;
            fill: var(--primary-neon);
            margin-bottom: 4px;
        }

        .icon-label {
            font-family: var(--font-display);
            font-size: 0.6rem;
            letter-spacing: 1px;
        }

        /* Content Styling */
        .player-header {
            background: var(--primary-neon);
            color: #000;
            padding: 8px 15px;
            font-family: var(--font-display);
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }

        #close-player {
            background: none;
            border: none;
            font-weight: bold;
            cursor: pointer;
            color: #000;
            font-size: 1rem;
        }

        .iframe-container {
            flex: 1;
            overflow: hidden;
            border-radius: 0 0 12px 12px;
        }

        /* --- Responsive Design --- */
        @media (max-width: 600px) {
            h1 {
                font-size: 2.5rem;
                margin-bottom: 20px;
            }

            .card {
                background: rgba(10, 10, 15, 0.95);
                border: 1px solid var(--glass-border);
                padding: 30px;
                border-radius: 16px;
                text-align: center;
                width: 400px;
                height: 550px;
                box-shadow: 0 0 30px rgba(0, 243, 255, 0.1), inset 0 0 20px rgba(0, 0, 0, 0.5);
                position: relative;
                overflow: hidden;
                margin: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .btn {
                padding: 12px 30px;
                font-size: 1rem;
                margin-top: 20px;
            }

            .select-group {
                margin: 15px 0;
            }

            #input-field {
                font-size: 1.5rem;
                height: 50px;
            }
        }

        /* --- Readme Widget --- */
        #readme-widget {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(5, 5, 10, 0.9);
            border: 2px solid var(--primary-neon);
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        #readme-widget:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--primary-neon);
        }

        #readme-widget .widget-label {
            font-family: var(--font-display);
            color: var(--primary-neon);
            font-size: 0.8rem;
            letter-spacing: 1px;
            text-align: center;
            line-height: 1.2;
        }

        /* Readme Overlay */
        #readme-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #readme-box {
            width: 600px;
            max-width: 90%;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid var(--primary-neon);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.2);
            position: relative;
            text-align: center;
        }

        #readme-box h2 {
            font-family: var(--font-display);
            color: #fff;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 0 0 10px var(--primary-neon);
        }

        #readme-box p {
            color: #ccc;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        #readme-box .contact-info {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #333;
        }

        #readme-box .contact-item {
            color: var(--primary-neon);
            font-family: var(--font-code);
            margin: 10px 0;
            font-size: 1.2rem;
        }

        #readme-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 1.5rem;
            cursor: pointer;
            transition: 0.3s;
        }

        #readme-close:hover {
            color: #fff;
        }


        #readme-overlay.hidden {
            display: none !important;
        }


        #result-screen .card {
            height: auto;
            min-height: 550px;
            padding-bottom: 50px;
            /* Ensure space for button */
        }

        #result-screen h1 {
            font-size: 3rem;
            /* Reduced from 4rem */
            line-height: 1.1;
            word-wrap: break-word;
            max-width: 100%;
            margin-bottom: 20px;
        }

        /* Ensure the card itself handles overflow gracefully if needed, though we want to avoid scrollbars inside the card */
        #result-screen .card {
            overflow: visible;
            /* Allow text shadow/glow to bleed if needed, but text should fit */
        }

        /* --- Auth UI --- */
        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(0, 243, 255, 0.2);
            gap: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: rgba(0, 0, 0, 0.6);
            color: #666;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 1rem;
            transition: all 0.3s;
            border: 1px solid transparent;
            outline: none;
            text-transform: uppercase;
            letter-spacing: 1px;
            clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%, 0 20%);
        }

        .auth-tab:hover {
            color: #fff;
            background: rgba(0, 243, 255, 0.1);
        }

        .auth-tab.active {
            background: rgba(0, 243, 255, 0.15);
            color: var(--primary-neon);
            border: 1px solid var(--primary-neon);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
            text-shadow: 0 0 5px var(--primary-neon);
        }

        .auth-form {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .auth-form.active {
            display: flex;
            animation: fadeIn 0.3s ease-out;
        }

        .auth-form input {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            padding: 15px;
            color: #fff;
            font-family: var(--font-code);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
            border-left: 3px solid #333;
        }

        .auth-form input:focus {
            border-color: var(--primary-neon);
            box-shadow: -5px 0 10px -5px var(--primary-neon);
            background: rgba(0, 243, 255, 0.05);
        }

        .auth-error {
            color: var(--danger-color);
            font-size: 0.85rem;
            min-height: 1.2em;
            text-shadow: 0 0 5px rgba(255, 0, 85, 0.5);
            font-family: var(--font-code);
        }

        .logged-in-view {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        .logged-in-view.active {
            display: flex;
        }

        .welcome-msg {
            font-size: 1.4rem;
            color: #fff;
            margin-bottom: 30px;
            font-family: var(--font-display);
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
            border: 1px solid var(--primary-neon);
            padding: 10px 30px;
            background: rgba(0, 243, 255, 0.05);
            clip-path: polygon(10% 0, 100% 0, 100% 80%, 90% 100%, 0 100%, 0 20%);
        }

        .welcome-msg span {
            color: var(--primary-neon);
            font-weight: bold;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }


        /* GLOBAL RESET */
        * {
            box-sizing: border-box;
        }

        /* Alignment Fixes V2 */
        .select-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
            width: 100% !important;
            /* Force full width */
        }

        .select-group label {
            color: var(--primary-neon);
            font-size: 0.8rem;
            letter-spacing: 1px;
            margin-left: 5px;
        }

        .select-group select {
            width: 100% !important;
            /* Force full width */
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #333;
            color: #fff;
            font-family: var(--font-code);
            outline: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .select-group select:hover {
            border-color: var(--primary-neon);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
        }

        #start-btn {
            width: 100% !important;
            /* Force full width */
            padding: 15px;
            font-size: 1.2rem;
            letter-spacing: 3px;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        .logged-in-view {
            gap: 10px;
            width: 100%;
            /* Ensure container is full width */
            padding: 0 20px;
            /* Add padding to match card */
        }

        /* Ensure card has no padding that interferes */
        #start-screen .card {
            padding: 40px;
            width: 450px;
            /* Fixed width for consistency */
        }
    </style>
</head>

<body>

    <div class="bg-grid"></div>
    <div class="scanlines"></div>
    <div class="vignette"></div>

    <!-- HUD -->
    <div id="hud">
        <div class="hud-group">
            <div class="hud-item">
                <span class="hud-label">Score</span>
                <span class="hud-value" id="score">0</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">Combo</span>
                <span class="hud-value" id="combo">0</span>
            </div>
        </div>

        <div class="hud-item">
            <span class="hud-label">Lives</span>
            <span class="hud-value" id="lives-display">♥♥♥</span>
        </div>

        <div class="hud-group">
            <div class="hud-item">
                <span class="hud-label">Progress</span>
                <span class="hud-value" id="progress">0/100</span>
            </div>
            <div class="hud-item">
                <span class="hud-label">Difficulty</span>
                <span class="hud-value" id="diff-badge">EASY</span>
            </div>
            <div class="hud-item" style="flex-direction: row; gap: 15px; align-items: center; margin-left: 20px;">
                <!-- Music button removed from here -->
                <button id="btn-pause" class="btn-small">PAUSE</button>
                <button id="btn-home" class="btn-small">HOME</button>
            </div>
        </div>
    </div>

    <!-- Game Area -->
    <div id="game-area">
        <!-- Words will be injected here -->
    </div>

    <!-- Input Area -->
    <div id="input-area">
        <div id="target-display"></div>
        <input type="text" id="input-field" placeholder="COMMAND_INPUT..." autocomplete="off" spellcheck="false">
    </div>

    <!-- Start Screen -->
    <!-- Start Screen -->
    <div id="start-screen" class="overlay">
        <h1 style="margin-bottom: 40px; font-size: 5rem; text-shadow: 0 0 20px var(--primary-neon);">CODEDROP</h1>

        <div
            style="display: flex; flex-direction: row; flex-wrap: wrap; gap: 40px; justify-content: center; align-items: center; width: 100%;">

            <!-- Main Menu Card -->
            <div class="card">
                <!-- Auth Container -->
                <div id="auth-container">
                    <div class="auth-tabs">
                        <button class="auth-tab active" id="tab-login">LOGIN</button>
                        <button class="auth-tab" id="tab-register">REGISTER</button>
                    </div>

                    <!-- Login Form -->
                    <div class="auth-form active" id="form-login">
                        <input type="text" id="login-nick" placeholder="NICKNAME" maxlength="16">
                        <input type="password" id="login-pass" placeholder="PASSWORD">
                        <div class="auth-error" id="login-error"></div>
                        <button class="btn" id="btn-login" style="margin-top: 10px;">LOGIN</button>
                    </div>

                    <!-- Register Form -->
                    <div class="auth-form" id="form-register">
                        <input type="text" id="reg-nick" placeholder="NICKNAME (3-16 chars)" maxlength="16">
                        <input type="password" id="reg-pass" placeholder="PASSWORD (min 4 chars)">
                        <input type="password" id="reg-pass-confirm" placeholder="CONFIRM PASSWORD">
                        <div class="auth-error" id="reg-error"></div>
                        <button class="btn" id="btn-register" style="margin-top: 10px;">REGISTER</button>
                    </div>
                </div>

                <!-- Logged In View -->
                <div id="logged-in-view" class="logged-in-view">
                    <div class="welcome-msg">WELCOME, <span id="user-display">AGENT</span></div>

                    <div class="select-group">
                        <label>System Difficulty</label>
                        <select id="difficulty-select">
                            <option value="EASY">EASY [SAFE_MODE]</option>
                            <option value="NORMAL" selected>NORMAL [STANDARD]</option>
                            <option value="DEVELOPER">DEVELOPER [OVERCLOCK]</option>
                        </select>
                    </div>
                    <div class="select-group">
                        <label>Data Pack</label>
                        <select id="pack-select">
                            <option value="PYTHON">Python Module</option>
                            <option value="JS">JavaScript Runtime</option>
                            <option value="HTTP">Network Protocols</option>
                            <option value="CLI">Terminal Commands</option>
                            <option value="VOCAB">Dev Vocabulary</option>
                            <option value="MIX">Full System Mix</option>
                        </select>
                    </div>
                    <button class="btn" id="start-btn">START</button>

                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn-small" id="btn-logout">LOGOUT</button>
                        <button class="btn-small btn-danger" id="btn-withdraw">WITHDRAW</button>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Preview -->
            <div id="leaderboard-preview">
                <h3
                    style="margin-bottom: 20px; color: var(--primary-neon); font-family: var(--font-display); letter-spacing: 2px; font-size: 1.5rem; text-shadow: 0 0 10px var(--primary-neon);">
                    TOP AGENTS</h3>
                <div id="leaderboard-list">
                    <div style="text-align: center; color: #666;">CONNECTING TO SERVER...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div id="pause-screen" class="overlay hidden">
        <h1>SYSTEM PAUSED</h1>
        <p>[ CLICK ANYWHERE TO RESUME ]</p>
    </div>

    <!-- Result Screen -->
    <div id="result-screen" class="overlay hidden">
        <div class="card">
            <h1 id="result-title">SESSION ENDED</h1>
            <div class="stat-grid">
                <div class="stat-item">
                    <div class="stat-label">Final Score</div>
                    <div class="stat-value" id="final-score">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Max Combo</div>
                    <div class="stat-value" id="final-combo">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">WPM</div>
                    <div class="stat-value" id="final-wpm">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Accuracy</div>
                    <div class="stat-value" id="final-acc">0%</div>
                </div>
            </div>
            <div id="submit-status"
                style="margin-bottom: 15px; color: var(--primary-neon); font-size: 0.9rem; font-family: var(--font-code);">
            </div>
            <button class="btn" id="restart-btn">Reboot System</button>
        </div>
    </div>

    <!-- Music Widget -->

    <!-- Readme Widget -->
    <div id="readme-widget">
        <div class="widget-label">READ<br>ME</div>
    </div>

    <!-- Readme Overlay -->
    <div id="readme-overlay" class="hidden">
        <div id="readme-box">
            <button id="readme-close">X</button>
            <h2>SYSTEM MANUAL</h2>

            <p>
                <strong>MISSION:</strong><br>
                Falling code fragments threaten the system integrity.<br>
                Type the commands exactly as they appear to neutralize them.
            </p>

            <p>
                <strong>PROTOCOL:</strong><br>
                Prevent fragments from reaching the bottom.<br>
                Maintain high accuracy for combo bonuses.
            </p>

            <div class="contact-info">
                <div style="color: #888; margin-bottom: 15px; font-size: 0.9rem;">SYSTEM ADMINISTRATOR CONTACT</div>
                <div class="contact-links">
                    <a href="https://github.com/souluk319" target="_blank" class="contact-link">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                        </svg>
                        GITHUB
                    </a>
                    <a href="https://kugnus.tistory.com" target="_blank" class="contact-link">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M0 0h24v24H0z" fill="none" />
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                        </svg>
                        BLOG
                    </a>
                    <a href="mailto:souluk319@naver.com" class="contact-link">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                        </svg>
                        EMAIL
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="music-widget" class="closed">
        <!-- Icon State -->
        <div class="widget-icon">
            <svg class="boombox-svg" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path
                    d="M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3v5c0 1.66 1.34 3 3 3v1c0 .55.45 1 1 1h16c.55 0 1-.45 1-1v-1c1.66 0 3-1.34 3-3v-5c0-1.66-1.34-3-3-3zM12 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm-4 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm10 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
            </svg>
            <span class="icon-label">MUSICBOX</span>
        </div>

        <!-- Content State -->
        <div class="widget-content">
            <div class="player-header">
                <span>CYBER_DECK // AUDIO</span>
                <button id="close-player">_</button>
            </div>
            <div class="iframe-container">
                <iframe width="100%" height="100%" scrolling="no" frameborder="no" allow="autoplay"
                    src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/kugnus/sets/kugnus-x-ai&color=%2300f3ff&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true">
                </iframe>
            </div>
        </div>
    </div>

    <script>
        /**
         * CodeDrop - Cyberpunk Edition
         */

        // --- API Config ---
        const API_BASE = "";

        // --- Data & Config ---

        const WORD_PACKS = {
            PYTHON: [
                // basics
                "def", "return", "class", "self", "import", "from", "as", "pass",
                "if", "elif", "else", "for", "while", "break", "continue",
                "try", "except", "finally", "raise", "with", "lambda",

                // built-in functions
                "print()", "input()", "len()", "range()", "open()", "type()", "id()",
                "str()", "int()", "float()", "bool()", "list()", "dict()", "set()", "tuple()",
                "enumerate()", "zip()", "map()", "filter()", "sorted()", "sum()", "min()", "max()",
                "any()", "all()", "dir()", "help()", "isinstance()",

                // common methods
                ".append()", ".pop()", ".sort()", ".reverse()", ".index()", ".count()",
                ".get()", ".items()", ".keys()", ".values()", ".update()",
                ".split()", ".join()", ".strip()", ".replace()", ".lower()", ".upper()",
                ".startswith()", ".endswith()", ".find()", ".format()",

                // standard library
                "import os", "import sys", "import time", "import math", "import random",
                "import json", "import re", "import datetime", "import collections",
                "os.path.join()", "os.listdir()", "sys.argv", "time.sleep()",
                "math.pi", "math.sqrt()", "random.randint()", "random.choice()",
                "json.loads()", "json.dumps()", "datetime.now()",

                // dunder methods
                "__init__", "__str__", "__repr__", "__name__", "__main__"
            ],

            JS: [
                // variables & syntax
                "const", "let", "var", "function", "=>", "return",
                "if", "else", "switch", "case", "break", "default",

                // error & control
                "try", "catch", "finally", "throw",
                "new", "this", "class", "extends", "super",

                // modules
                "import", "export", "require()", "module.exports",

                // browser
                "console.log", "document", "window", "navigator", "location",
                "querySelector()", "addEventListener()", "removeEventListener()",

                // storage & fetch
                "localStorage", "sessionStorage", "fetch()", "Headers",
                "Request", "Response",

                // async
                "Promise", "then()", "catch()", "finally()",
                "async", "await",

                // arrays & objects
                "map()", "filter()", "reduce()", "forEach()", "find()", "some()", "every()",
                "Object.keys()", "Object.values()", "Object.entries()",

                // json
                "JSON.parse", "JSON.stringify",

                // node & tooling
                "npm install", "npm run", "npx",
                "package.json", "node_modules",
                "webpack", "babel", "vite", "eslint", "prettier",

                // frameworks
                "react", "vue", "svelte", "next.js", "express"
            ],

            HTTP: [
                // methods
                "GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS",

                // status
                "200 OK", "201 Created", "204 No Content",
                "301 Moved Permanently", "302 Found",
                "400 Bad Request", "401 Unauthorized", "403 Forbidden",
                "404 Not Found", "409 Conflict",
                "500 Internal Server Error", "502 Bad Gateway", "503 Service Unavailable",

                // headers
                "Content-Type", "Content-Length", "Authorization",
                "Bearer", "Cache-Control", "ETag", "Cookie", "Set-Cookie",
                "User-Agent", "Accept", "Accept-Encoding", "Origin", "Referer",

                // concepts
                "CORS", "HTTPS", "SSL", "TLS", "DNS", "IP Address",
                "localhost", "127.0.0.1", "0.0.0.0",
                "port 80", "port 443", "port 3000", "port 8000",

                // api
                "REST API", "GraphQL", "JSON", "request body", "query string",
                "path parameter", "response payload", "rate limit"
            ],

            CLI: [
                // git
                "git init", "git clone", "git status", "git add .", "git commit",
                "git push", "git pull", "git fetch", "git merge",
                "git checkout", "git branch", "git rebase",
                "git log", "git diff", "git stash", "git reset",

                // docker
                "docker ps", "docker images", "docker build", "docker run",
                "docker stop", "docker rm", "docker rmi",
                "docker-compose up", "docker-compose down",

                // shell
                "ls -la", "pwd", "cd ..", "mkdir", "rm -rf",
                "touch", "cat", "less", "more",
                "grep", "awk", "sed", "curl", "wget",
                "ssh", "scp",

                // permissions
                "chmod", "chown", "sudo",

                // package managers
                "apt-get update", "apt-get install",
                "brew install", "brew update",

                // env
                "echo $PATH", "export PATH", "env", "which",
                "history", "clear"
            ],

            VOCAB: [
                // general dev
                "API", "SDK", "IDE", "GUI", "CLI",
                "JSON", "XML", "YAML", "HTML", "CSS",
                "SQL", "NoSQL",

                // architecture
                "Database", "Server", "Client",
                "Frontend", "Backend", "Fullstack",
                "Monolith", "Microservice",

                // infra
                "DevOps", "CI/CD", "Pipeline",
                "Build", "Deploy", "Rollback",

                // CS
                "Algorithm", "Data Structure", "Big O",
                "Recursion", "Iteration",
                "Stack", "Queue", "Heap", "HashMap",

                // language
                "Variable", "Constant", "Function", "Method",
                "Class", "Object", "Interface",
                "Array", "String", "Integer", "Boolean", "Float",

                // quality
                "Bug", "Debug", "Test", "Refactor",
                "Lint", "Format",

                // performance
                "Latency", "Throughput", "Bandwidth",
                "Concurrency", "Parallelism", "Deadlock"
            ],

            MIX: [] // 아래에서 자동 합성 추천
        };


        // Populate MIX
        WORD_PACKS.MIX = Object.values(WORD_PACKS)
            .filter(pack => Array.isArray(pack))
            .flat();


        const DIFFICULTY = {
            EASY: { spawnRate: 2500, speedMin: 0.5, speedMax: 1.0, eventChance: 0 },
            NORMAL: { spawnRate: 2000, speedMin: 0.7, speedMax: 1.3, eventChance: 0 },
            DEVELOPER: { spawnRate: 1500, speedMin: 2, speedMax: 3.5, eventChance: 0 }
        };

        // --- Game State ---

        const state = {
            score: 0,
            lives: 3,
            combo: 0,
            maxCombo: 0,
            spawnedCount: 0,
            activeWords: [], // { id, text, x, y, speed, el, isEvent }
            isPlaying: false,
            isPaused: false,
            difficulty: 'NORMAL',
            pack: 'PYTHON',
            startTime: 0,
            totalCharsTyped: 0,
            correctCharsTyped: 0,
            targetId: null, // ID of the word currently being targeted
            lastSpawnTime: 0,
            userId: null, // From API
            nickname: ''
        };

        // --- DOM Elements ---

        const els = {
            hud: {
                score: document.getElementById('score'),
                combo: document.getElementById('combo'),
                lives: document.getElementById('lives-display'),
                progress: document.getElementById('progress'),
                diff: document.getElementById('diff-badge'),
                btnPause: document.getElementById('btn-pause'),
                btnHome: document.getElementById('btn-home')
            },
            gameArea: document.getElementById('game-area'),
            input: {
                field: document.getElementById('input-field'),
                target: document.getElementById('target-display')
            },
            screens: {
                start: document.getElementById('start-screen'),
                result: document.getElementById('result-screen'),
                pause: document.getElementById('pause-screen')
            },
            result: {
                title: document.getElementById('result-title'),
                score: document.getElementById('final-score'),
                combo: document.getElementById('final-combo'),
                wpm: document.getElementById('final-wpm'),
                acc: document.getElementById('final-acc'),
                status: document.getElementById('submit-status')
            },
            controls: {
                diffSelect: document.getElementById('difficulty-select'),
                packSelect: document.getElementById('pack-select'),
                startBtn: document.getElementById('start-btn'),
                restartBtn: document.getElementById('restart-btn'),
                leaderboard: document.getElementById('leaderboard-list')
            },
            auth: {
                tabs: {
                    login: document.getElementById('tab-login'),
                    register: document.getElementById('tab-register')
                },
                forms: {
                    login: document.getElementById('form-login'),
                    register: document.getElementById('form-register')
                },
                inputs: {
                    loginNick: document.getElementById('login-nick'),
                    loginPass: document.getElementById('login-pass'),
                    regNick: document.getElementById('reg-nick'),
                    regPass: document.getElementById('reg-pass'),
                    regPassConfirm: document.getElementById('reg-pass-confirm')
                },
                btns: {
                    login: document.getElementById('btn-login'),
                    register: document.getElementById('btn-register'),
                    logout: document.getElementById('btn-logout'),
                    withdraw: document.getElementById('btn-withdraw')
                },
                errors: {
                    login: document.getElementById('login-error'),
                    register: document.getElementById('reg-error')
                },
                loggedInView: document.getElementById('logged-in-view'),
                authContainer: document.getElementById('auth-container'),
                userDisplay: document.getElementById('user-display')
            },
            musicWidget: document.getElementById('music-widget')
        };

        // --- Sound FX (Web Audio API & WAVs) ---
        const sfx = {
            ctx: null,
            sounds: {},
            bgm: null,
            loaded: false,
            init: function () {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!this.ctx) {
                    this.ctx = new AudioContext();
                } else if (this.ctx.state === 'suspended') {
                    this.ctx.resume();
                }

                if (!this.loaded) {
                    // Load WAVs
                    this.sounds.enter = new Audio('sound/enter.wav');
                    this.sounds.backspace = new Audio('sound/backspace2.wav');
                    this.sounds.space = new Audio('sound/spacebar.wav');
                    this.sounds.space.volume = 0.5;
                    this.sounds.key = new Audio('sound/key.wav');
                    this.sounds.correct = new Audio('sound/correct_sound.wav');

                    this.bgm = new Audio('sound/mainpage_bgm.wav');
                    this.bgm.loop = false;
                    this.bgm.volume = 0.5;

                    this.loaded = true;
                }
            },
            playBGM: function () {
                if (this.bgm) {
                    this.bgm.currentTime = 0;
                    const promise = this.bgm.play();
                    if (promise !== undefined) {
                        promise.catch(error => {
                            console.log("BGM Autoplay blocked. Waiting for interaction.");
                            const playOnInteraction = () => {
                                this.bgm.play();
                                document.removeEventListener('click', playOnInteraction);
                                document.removeEventListener('keydown', playOnInteraction);
                            };
                            document.addEventListener('click', playOnInteraction);
                            document.addEventListener('keydown', playOnInteraction);
                        });
                    }
                }
            },
            playKey: function (key) {
                let sound;
                if (key === 'Enter') sound = this.sounds.enter;
                else if (key === 'Backspace') sound = this.sounds.backspace;
                else if (key === ' ') sound = this.sounds.space;
                else sound = this.sounds.key;

                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(() => { });
                }
            },
            playTone: function (freq, type, duration, vol = 0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();

                osc.type = type;
                osc.frequency.setValueAtTime(freq, this.ctx.currentTime);

                gain.gain.setValueAtTime(vol, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

                osc.connect(gain);
                gain.connect(this.ctx.destination);

                osc.start();
                osc.stop(this.ctx.currentTime + duration);
            },
            playSuccess: function () {
                if (this.sounds.correct) {
                    this.sounds.correct.currentTime = 0;
                    this.sounds.correct.play().catch(() => { });
                } else {
                    // Fallback
                    this.playTone(880, 'sine', 0.1, 0.1);
                }
            },
            playFail: function () {
                // Keep existing synth
                this.playTone(150, 'sawtooth', 0.3, 0.1);
                this.playTone(100, 'square', 0.3, 0.1);
            }
        };

        // --- Game Logic ---


        async function fetchLeaderboard() {
            // Only fetch if start screen is visible (optimization)
            if (els.screens.start.classList.contains('hidden')) return;

            try {
                const diff = els.controls.diffSelect.value.split(' ')[0].toLowerCase(); // Handle "EASY [SAFE_MODE]"
                const pack = els.controls.packSelect.value.toLowerCase();

                const res = await fetch(`${API_BASE}/leaderboard?difficulty=${diff}&pack=${pack}`);
                const data = await res.json();

                renderLeaderboard(data.top10);
            } catch (e) {
                console.error(e);
                els.controls.leaderboard.innerHTML = '<div style="text-align:center; color:var(--danger-color);">CONNECTION LOST</div>';
            }
        }

        function updateHUD() {
            els.hud.score.textContent = state.score;
            els.hud.combo.textContent = state.combo;
            els.hud.progress.textContent = `${state.spawnedCount}/100`;

            // Fix: Handle difficulty text with brackets
            const diffKey = state.difficulty.split(' ')[0];
            els.hud.diff.textContent = diffKey;

            let hearts = '';
            for (let i = 0; i < state.lives; i++) hearts += '♥';
            els.hud.lives.textContent = hearts;

            // Update Pause Button Text
            if (els.hud.btnPause) {
                els.hud.btnPause.textContent = state.isPaused ? "RESUME" : "PAUSE";
            }
        }

        function gameLoop(timestamp) {
            if (!state.isPlaying) return;
            if (state.isPaused) {
                requestAnimationFrame(gameLoop);
                return;
            }

            // Parse difficulty from select value (e.g. "EASY [SAFE_MODE]")
            const diffKey = state.difficulty.split(' ')[0];
            const diffConfig = DIFFICULTY[diffKey];
            const playfieldHeight = els.gameArea.clientHeight;

            // Spawning
            if (state.spawnedCount < 100) {
                if (timestamp - state.lastSpawnTime > diffConfig.spawnRate) {
                    spawnWord();
                    state.lastSpawnTime = timestamp;
                }
            } else if (state.activeWords.length === 0) {
                // All spawned and all cleared
                gameOver(true);
                return;
            }

            // Update Words
            state.activeWords.forEach((word, index) => {
                word.y += word.speed;
                word.el.style.top = `${word.y}px`;

                // Collision Check (Bottom)
                if (word.y > playfieldHeight - 30) {
                    handleDrop(index);
                }
            });

            requestAnimationFrame(gameLoop);
        }

        function spawnWord() {
            state.spawnedCount++;
            updateHUD();

            const isEvent = [15, 30, 45, 60, 75, 90].includes(state.spawnedCount);

            // Filter pool to exclude currently active words to prevent duplicates
            let pool = WORD_PACKS[state.pack];
            const activeTexts = state.activeWords.map(w => w.text);
            const filteredPool = pool.filter(word => !activeTexts.includes(word));

            // Use filtered pool if available, otherwise fallback to full pool
            if (filteredPool.length > 0) {
                pool = filteredPool;
            }

            const text = pool[Math.floor(Math.random() * pool.length)];
            const diffKey = state.difficulty.split(' ')[0];
            const diffConfig = DIFFICULTY[diffKey];

            const word = {
                id: Date.now() + Math.random(),
                text: text,
                x: Math.random() * 80 + 10, // 10% to 90%
                y: -40,
                speed: diffConfig.speedMin + Math.random() * (diffConfig.speedMax - diffConfig.speedMin),
                isEvent: isEvent,
                el: document.createElement('div')
            };

            // DOM Creation
            word.el.className = 'word-item';
            if (isEvent) word.el.classList.add('event');
            word.el.textContent = text;
            word.el.style.left = `${word.x}%`;
            word.el.style.top = `${word.y}px`;

            els.gameArea.appendChild(word.el);
            state.activeWords.push(word);
        }

        function handleInput(e) {
            const inputVal = e.target.value;
            state.totalCharsTyped++;

            // 1. Find Target if none
            if (!state.targetId) {
                // Find matching words (prefix match)
                const matches = state.activeWords.filter(w => w.text.startsWith(inputVal));

                if (matches.length > 0) {
                    // Pick lowest (largest y)
                    matches.sort((a, b) => b.y - a.y);
                    const target = matches[0];
                    state.targetId = target.id;

                    // Highlight
                    state.activeWords.forEach(w => w.el.classList.remove('target'));
                    target.el.classList.add('target');
                }
            }

            // 2. Validate against Target
            if (state.targetId) {
                const target = state.activeWords.find(w => w.id === state.targetId);

                // If target disappeared (dropped) or input no longer matches prefix
                if (!target || !target.text.startsWith(inputVal)) {
                    // Reset target
                    state.targetId = null;
                    state.activeWords.forEach(w => w.el.classList.remove('target'));

                    // If input is not empty, try to find new target immediately
                    if (inputVal.length > 0) {
                        handleInput(e); // Recursive check for new target
                        return;
                    }
                } else {
                    // Still matching target
                    updateTargetDisplay(inputVal, target.text);
                }
            } else {
                updateTargetDisplay(inputVal);
            }
        }

        function handleKeydown(e) {
            sfx.playKey(e.key);

            if (e.key === 'Enter') {
                const inputVal = els.input.field.value;

                if (state.targetId) {
                    const targetIndex = state.activeWords.findIndex(w => w.id === state.targetId);
                    if (targetIndex !== -1) {
                        const target = state.activeWords[targetIndex];
                        if (target.text === inputVal) {
                            // Success
                            successWord(targetIndex);
                        } else {
                            // Typo Enter
                            failTypo();
                        }
                    }
                } else {
                    // Enter with no target or no match
                    failTypo();
                }

                // Clear input
                els.input.field.value = '';
                updateTargetDisplay('');
                state.targetId = null;
                state.activeWords.forEach(w => w.el.classList.remove('target'));
            }
        }

        function successWord(index) {
            const word = state.activeWords[index];

            // Score
            const points = word.isEvent ? 50 : 10;
            state.combo++;
            if (state.combo > state.maxCombo) state.maxCombo = state.combo;

            const bonus = Math.min(state.combo, 10);
            state.score += points + bonus;

            state.correctCharsTyped += word.text.length;

            // Play Success Sound
            sfx.playSuccess();

            // Remove
            word.el.classList.add('matched');
            setTimeout(() => {
                if (word.el.parentNode) word.el.parentNode.removeChild(word.el);
            }, 200);

            state.activeWords.splice(index, 1);
            updateHUD();
        }

        function failTypo() {
            // Play Fail Sound
            sfx.playFail();

            state.score = Math.max(0, state.score - 5);
            state.combo = 0;
            updateHUD();

            // Shake input
            els.input.field.classList.add('error');
            setTimeout(() => els.input.field.classList.remove('error'), 300);
        }

        function updateTargetDisplay(input, fullText = '') {
            if (!fullText) {
                els.input.target.textContent = '';
                return;
            }

            // Highlight matched part
            const matched = fullText.substring(0, input.length);
            const rest = fullText.substring(input.length);

            els.input.target.innerHTML = `<span class="match">${matched}</span><span class="rest">${rest}</span>`;
        }


        function handleDrop(index) {
            const word = state.activeWords[index];

            // Remove from DOM
            if (word.el.parentNode) word.el.parentNode.removeChild(word.el);

            // Remove from array
            state.activeWords.splice(index, 1);

            // Reset Target if dropped
            if (state.targetId === word.id) {
                state.targetId = null;
                updateTargetDisplay('');
            }

            // Logic
            state.lives--;
            state.combo = 0;
            updateHUD();

            // Visual Feedback
            els.hud.lives.style.opacity = 0.5;
            setTimeout(() => els.hud.lives.style.opacity = 1, 200);

            if (state.lives <= 0) {
                gameOver(false);
            }
        }

        async function gameOver(victory = false) {
            state.isPlaying = false;
            state.isPaused = false;

            // Calculate Stats
            const durationMin = (Date.now() - state.startTime) / 60000;
            const wpm = durationMin > 0 ? Math.round((state.correctCharsTyped / 5) / durationMin) : 0;
            const accuracy = state.totalCharsTyped > 0 ? Math.round((state.correctCharsTyped / state.totalCharsTyped) * 100) : 0;

            // Update Result Screen
            els.result.title.textContent = victory ? "MISSION COMPLETE" : "SYSTEM FAILURE";
            els.result.title.style.color = victory ? "var(--success-color)" : "var(--danger-color)";
            els.result.title.style.textShadow = victory ? "0 0 20px var(--success-color)" : "0 0 20px var(--danger-color)";

            els.result.score.textContent = state.score;
            els.result.combo.textContent = state.maxCombo;
            els.result.wpm.textContent = wpm;
            els.result.acc.textContent = accuracy + "%";

            els.screens.result.classList.remove('hidden');

            // Submit Score
            if (state.userId) {
                els.result.status.textContent = "UPLOADING DATA...";
                try {
                    const res = await fetch(`${API_BASE}/submit`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_id: state.userId,
                            score: state.score,
                            wpm: wpm,
                            accuracy: accuracy,
                            difficulty: state.difficulty.toLowerCase(),
                            pack: state.pack.toLowerCase()
                        })
                    });
                    const data = await res.json();
                    if (data.ok) {
                        els.result.status.textContent = "UPLOAD COMPLETE. CHECK RANKING.";
                    } else {
                        els.result.status.textContent = "UPLOAD FAILED.";
                    }
                } catch (e) {
                    console.error(e);
                    els.result.status.textContent = "SERVER ERROR. DATA NOT SAVED.";
                }
            } else {
                els.result.status.textContent = "OFFLINE MODE. DATA NOT SAVED.";
            }
        }

        function renderLeaderboard(list) {
            if (!list || list.length === 0) {
                els.controls.leaderboard.innerHTML = '<div style="text-align:center; color:#666;">NO DATA FOUND. BE THE FIRST.</div>';
                return;
            }

            let html = '<table>';
            html += '<tr><th>RANK</th><th>AGENT</th><th style="text-align:right;">SCORE</th><th style="text-align:right;">WPM</th></tr>';

            list.forEach((item, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : '';
                const nameStyle = rank <= 3 ? 'color:var(--primary-neon); font-weight:bold; font-size: 1.1em;' : 'color:var(--primary-neon);';

                html += `<tr>
            <td class="${rankClass}" style="font-weight:bold;">#${rank}</td>
            <td style="${nameStyle}">${item.nickname}</td>
            <td style="text-align:right; font-family:var(--font-code); color:#fff;">${item.score}</td>
            <td style="text-align:right; font-family:var(--font-code); color:#888;">${item.wpm}</td>
        </tr>`;
            });
            html += '</table>';

            els.controls.leaderboard.innerHTML = html;
        }



        function startGame() {
            console.log('Starting Game...');
            // Validate
            const diff = els.controls.diffSelect.value;
            const pack = els.controls.packSelect.value;

            state.difficulty = diff;
            state.pack = pack;

            // UI Reset
            els.screens.start.classList.add('hidden');
            els.screens.pause.classList.add('hidden');
            els.screens.result.classList.add('hidden');
            els.gameArea.innerHTML = ''; // Clear words
            els.input.field.value = '';
            els.input.field.disabled = false;
            els.input.field.focus();
            els.hud.btnPause.textContent = "PAUSE";

            // State Reset
            state.isPlaying = true;
            state.isPaused = false;
            state.score = 0;
            state.lives = 3;
            state.combo = 0;
            state.maxCombo = 0;
            state.spawnedCount = 0;
            state.activeWords = [];
            state.startTime = Date.now();
            state.lastSpawnTime = Date.now();
            state.totalCharsTyped = 0;
            state.correctCharsTyped = 0;
            state.targetId = null;

            updateHUD();

            // Start Loop
            requestAnimationFrame(gameLoop);

            // Play BGM
            // // sfx.playBGM();
        }

        function togglePause() {
            if (!state.isPlaying) return;

            state.isPaused = !state.isPaused;

            if (state.isPaused) {
                els.hud.btnPause.textContent = "PLAY";
                els.screens.pause.classList.remove('hidden');
                els.input.field.disabled = true;
            } else {
                els.hud.btnPause.textContent = "PAUSE";
                els.screens.pause.classList.add('hidden');
                els.input.field.disabled = false;
                els.input.field.focus();
                state.lastSpawnTime = Date.now();
            }
        }

        function goHome() {
            if (confirm("ABORT MISSION? Progress will be lost.")) {
                state.isPlaying = false;
                state.isPaused = false;
                els.screens.pause.classList.add('hidden');
                els.screens.result.classList.add('hidden');
                els.screens.start.classList.remove('hidden');

                // Clear game area
                els.gameArea.innerHTML = '';
                state.activeWords = [];

                fetchLeaderboard();
                initGameControls();
                // sfx.playBGM();
            }
        }

        // Add Listeners for Game Controls

        // Named handlers to prevent duplicates
        function handleRestart() {
            els.screens.result.classList.add('hidden');
            els.screens.start.classList.remove('hidden');
            fetchLeaderboard();
            // sfx.playBGM();
        }

        function handleMusicWidgetClick(e) {
            // If clicking close button, minimize
            if (e.target.id === 'close-player') {
                e.stopPropagation();
                els.musicWidget.classList.remove('open');
                els.musicWidget.classList.add('closed');
                return;
            }

            // If closed, open it
            if (els.musicWidget.classList.contains('closed')) {
                els.musicWidget.classList.remove('closed');
                els.musicWidget.classList.add('open');
            }
        }

        // Add Listeners for Game Controls
        function initGameControls() {
            // Remove existing to be safe (though named functions handle this mostly)
            els.input.field.removeEventListener('input', handleInput);
            els.input.field.removeEventListener('keydown', handleKeydown);
            els.hud.btnPause.removeEventListener('click', togglePause);
            els.hud.btnHome.removeEventListener('click', goHome);
            els.screens.pause.removeEventListener('click', togglePause);
            els.controls.restartBtn.removeEventListener('click', handleRestart);
            if (els.musicWidget) els.musicWidget.removeEventListener('click', handleMusicWidgetClick);

            // Add
            els.input.field.addEventListener('input', handleInput);
            els.input.field.addEventListener('keydown', handleKeydown);
            els.hud.btnPause.addEventListener('click', togglePause);
            els.hud.btnHome.addEventListener('click', goHome);
            els.screens.pause.addEventListener('click', togglePause);
            els.controls.restartBtn.addEventListener('click', handleRestart);

            // Music Widget Logic
            if (els.musicWidget) {
                els.musicWidget.addEventListener('click', handleMusicWidgetClick);
            }


            // Readme Logic
            const readmeWidget = document.getElementById('readme-widget');
            const readmeOverlay = document.getElementById('readme-overlay');
            const readmeClose = document.getElementById('readme-close');

            if (readmeWidget && readmeOverlay && readmeClose) {
                readmeWidget.addEventListener('click', () => {
                    readmeOverlay.classList.remove('hidden');
                    sfx.playKey('Enter'); // Sound feedback
                });

                readmeClose.addEventListener('click', () => {
                    readmeOverlay.classList.add('hidden');
                });

                readmeOverlay.addEventListener('click', (e) => {
                    if (e.target === readmeOverlay) {
                        readmeOverlay.classList.add('hidden');
                    }
                });
            }

            console.log("Game Controls Initialized");
        }

        function init() {
            initAuth();

            // Restore Nickname if any (though we use auth now)
            // const savedNick = localStorage.getItem('codedrop_nickname');
            // if (savedNick) els.controls.nickname.value = savedNick;

            // Load Initial Leaderboard
            fetchLeaderboard();
            initGameControls();

            
            // Sfx Init on interaction
            const initAudio = () => {
                sfx.init();
                sfx.playBGM();
                console.log("Audio Initialized & BGM Started");
                document.removeEventListener('click', initAudio);
                document.removeEventListener('keydown', initAudio);
            };

            document.addEventListener('click', initAudio);
            document.addEventListener('keydown', initAudio);
        }

        // --- Auth Logic ---
        function initAuth() {
            // Check LocalStorage
            const storedUser = localStorage.getItem('codedrop_user');
            if (storedUser) {
                try {
                    const user = JSON.parse(storedUser);
                    state.userId = user.id;
                    state.nickname = user.nickname;
                    showLoggedInView();
                } catch (e) {
                    localStorage.removeItem('codedrop_user');
                    showAuthView();
                }
            } else {
                showAuthView();
            }

            // Tabs
            els.auth.tabs.login.addEventListener('click', () => switchTab('login'));
            els.auth.tabs.register.addEventListener('click', () => switchTab('register'));

            // Buttons
            els.auth.btns.login.addEventListener('click', handleLogin);
            els.auth.btns.register.addEventListener('click', handleRegister);
            els.auth.btns.logout.addEventListener('click', handleLogout);
            els.auth.btns.withdraw.addEventListener('click', handleWithdraw);

            // Start Button (now in logged in view)
            els.controls.startBtn.addEventListener('click', startGame);
        }

        function switchTab(tab) {
            els.auth.tabs.login.classList.toggle('active', tab === 'login');
            els.auth.tabs.register.classList.toggle('active', tab === 'register');
            els.auth.forms.login.classList.toggle('active', tab === 'login');
            els.auth.forms.register.classList.toggle('active', tab === 'register');

            // Clear errors
            els.auth.errors.login.textContent = '';
            els.auth.errors.register.textContent = '';
        }

        async function handleLogin() {
            const nickname = els.auth.inputs.loginNick.value.trim();
            const password = els.auth.inputs.loginPass.value.trim();

            if (!nickname || !password) {
                els.auth.errors.login.textContent = "Please enter nickname and password.";
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname, password })
                });
                const data = await res.json();

                if (res.ok) {
                    // Success
                    loginSuccess(data.user_id, data.nickname);
                } else {
                    els.auth.errors.login.textContent = data.error || "Login failed.";
                }
            } catch (e) {
                els.auth.errors.login.textContent = "Server error.";
            }
        }

        async function handleRegister() {
            const nickname = els.auth.inputs.regNick.value.trim();
            const password = els.auth.inputs.regPass.value.trim();
            const confirm = els.auth.inputs.regPassConfirm.value.trim();

            if (!nickname || !password) {
                els.auth.errors.register.textContent = "All fields required.";
                return;
            }
            if (password.length < 4) {
                els.auth.errors.register.textContent = "Password too short (min 4).";
                return;
            }
            if (password !== confirm) {
                els.auth.errors.register.textContent = "Passwords do not match.";
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname, password })
                });
                const data = await res.json();

                if (res.ok) {
                    // Success -> Auto Login
                    loginSuccess(data.user_id, data.nickname);
                } else {
                    els.auth.errors.register.textContent = data.error || "Registration failed.";
                }
            } catch (e) {
                els.auth.errors.register.textContent = "Server error.";
            }
        }

        function loginSuccess(id, nickname) {
            state.userId = id;
            state.nickname = nickname;
            localStorage.setItem('codedrop_user', JSON.stringify({ id, nickname }));
            showLoggedInView();
        }

        function handleLogout() {
            state.userId = null;
            state.nickname = '';
            localStorage.removeItem('codedrop_user');

            // Clear inputs
            els.auth.inputs.loginNick.value = '';
            els.auth.inputs.loginPass.value = '';
            els.auth.inputs.regNick.value = '';
            els.auth.inputs.regPass.value = '';
            els.auth.inputs.regPassConfirm.value = '';

            showAuthView();
        }

        async function handleWithdraw() {
            if (!confirm("Are you sure you want to delete your account? This cannot be undone.")) return;

            const password = prompt("Please enter your password to confirm deletion:");
            if (!password) return;

            try {
                const res = await fetch(`${API_BASE}/withdraw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: state.userId, password })
                });

                if (res.ok) {
                    alert("Account deleted.");
                    handleLogout();
                } else {
                    const data = await res.json();
                    alert("Failed: " + (data.error || "Unknown error"));
                }
            } catch (e) {
                alert("Server error.");
            }
        }

        function showLoggedInView() {
            els.auth.authContainer.style.display = 'none';
            els.auth.loggedInView.classList.add('active');
            els.auth.userDisplay.textContent = state.nickname;

            // Refresh leaderboard for default view
            fetchLeaderboard();
            initGameControls();
        }

        function showAuthView() {
            els.auth.authContainer.style.display = 'block';
            els.auth.loggedInView.classList.remove('active');
            switchTab('login');
        }

        // Start
        init();

    </script>

    <!-- Readme Widget -->
    <div id="readme-widget">
        <div class="widget-label">READ<br>ME</div>
    </div>

    <!-- Readme Overlay -->
    <div id="readme-overlay" class="hidden">
        <div id="readme-box">
            <button id="readme-close">X</button>
            <h2>SYSTEM MANUAL</h2>

            <p>
                <strong>MISSION:</strong><br>
                Falling code fragments threaten the system integrity.<br>
                Type the commands exactly as they appear to neutralize them.
            </p>

            <p>
                <strong>PROTOCOL:</strong><br>
                Prevent fragments from reaching the bottom.<br>
                Maintain high accuracy for combo bonuses.
            </p>

            <div class="contact-info">
                <div style="color: #888; margin-bottom: 15px; font-size: 0.9rem;">SYSTEM ADMINISTRATOR CONTACT</div>
                <div class="contact-links">
                    <a href="https://github.com/souluk319" target="_blank" class="contact-link">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                        </svg>
                        GITHUB
                    </a>
                    <a href="https://kugnus.tistory.com" target="_blank" class="contact-link">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path d="M0 0h24v24H0z" fill="none" />
                            <path
                                d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                        </svg>
                        BLOG
                    </a>
                    <a href="mailto:souluk319@naver.com" class="contact-link">
                        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                            <path
                                d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
                        </svg>
                        EMAIL
                    </a>
                </div>
            </div>
        </div>
    </div>

</body>

</html>